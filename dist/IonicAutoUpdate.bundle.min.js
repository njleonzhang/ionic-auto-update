"use strict";angular.module("ionicAutoUpdate",[]).service("IonicAutoUpdate",["$q","$timeout","$cordovaFileTransfer","$cordovaFileOpener2","$filter",function(n,o,e,t,r){function i(o,e,t){var r=n.defer();return navigator.notification&&navigator.notification.alert(o,function(){r.resolve()},e,t),r.promise}function a(o,e,t){var r=n.defer();return navigator.notification&&navigator.notification.confirm(o,function(n){r.resolve(n)},e,t),r.promise}function c(n,o){window.localStorage[n]=JSON.stringify(o)}function u(n){return JSON.parse(window.localStorage[n]||"{}")}function l(n,o){return e.download(n,o,{},!0)}function f(n){return t.open(n,"application/vnd.android.package-archive")}function s(){cordova.plugin.pDialog.init({theme:"HOLO_DARK",progressStyle:"HORIZONTAL",cancelable:!1,title:"版本升级",message:"下载中..."})}function d(n){cordova.plugin.pDialog.setProgress(n)}function g(){cordova.plugin.pDialog.dismiss()}function p(o){var e=n.defer();s();var t=o.path+o.filename,r=0;return l(o.url,t).then(function(n){console.log("下载成功",n),o.downloadSuccessCb(n),g(),f(t).then(function(){console.log("打开成功"),e.resolve()},function(){console.log("打开失败"),e.reject()})},function(n){console.log("下载失败",n),g(),e.reject(n)},function(n){r=Math.floor(n.loaded/n.total*100),d(r),r>99&&g()}),e.promise}function v(o){var e=n.defer();return cordova.InAppBrowser.open(o.url,"_system"),e.resolve(),e.promise}function w(n){var o=new Date;return o.toDateString()===n.toDateString()}function m(){var n=u("upgradeSuggestionInfo");return!(!n||!w(new Date(n.last_suggest_date)))}function h(){var e=n.defer();return i("在使用前您必须更新!","更新提醒","去更新").then(function(){D().then(function(){e.resolve(),o(h,500)},function(){e.reject()})}),e.promise}function S(e){return e=e||n.defer(),m()?e.reject():a("新版本上线啦","更新提醒",["去更新","暂不更新"]).then(function(n){if(1==n)D().then(function(){o(angular.bind(null,S,e),500)},function(){e.reject()});else if(2==n){var t={last_suggest_date:r("date")(new Date,"yyyy-MM-dd")};console.log(t),c("upgradeSuggestionInfo",t),e.reject()}else e.reject()}),e.promise}var D,y,O=ionic.Platform.platform();this.init=function(n){var o=n.iOSDownloadUrl,e=void 0===o?"":o,t=n.androidDownloadUrl,r=void 0===t?"":t,i=n.path,a=void 0===i?cordova.file.externalApplicationStorageDirectory:i,c=n.filename,u=void 0===c?"new_version.apk":c,l=n.downloadSuccessCb,f=void 0===l?function(){}:l,s={ios:{url:e},android:{url:r,path:a,filename:u,downloadSuccessCb:f}}[O];if(!s.url)throw new Error("undefined url");D={ios:function(){return v(s)},android:function(){return p(s)}}[O],y={force:function(){return h()},suggest:function(){return S()}}},this.start=function(n){if(!D||!y)throw new Error("AppUpdate not init");return y[n].call()}}]);