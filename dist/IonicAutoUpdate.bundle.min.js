"use strict";angular.module("ionicAutoUpdate",[]).service("NativeAlert",["$q",function(n){this.showAlert=function(o,e,t){var r=n.defer();return navigator.notification&&navigator.notification.alert(o,function(){r.resolve()},e,t),r.promise},this.showConfirm=function(o,e,t){var r=n.defer();return navigator.notification&&navigator.notification.confirm(o,function(n){r.resolve(n)},e,t),r.promise}}]).service("BSYLocalStorage",function(){this.setStr=function(n,o){window.localStorage[n]=o},this.getStr=function(n){return window.localStorage[n]||""},this.setJsonObj=function(n,o){window.localStorage[n]=JSON.stringify(o)},this.getJsonObj=function(n){return JSON.parse(window.localStorage[n]||"{}")},this.remove=function(n){window.localStorage.removeItem(n)}}).service("IonicAutoUpdate",["$q","$timeout","$cordovaFileTransfer","$cordovaFileOpener2","BSYLocalStorage","$filter","NativeAlert",function(n,o,e,t,r,i,a){function c(n,o){return e.download(n,o,{},!0)}function u(n){return t.open(n,"application/vnd.android.package-archive")}function l(){cordova.plugin.pDialog.init({theme:"HOLO_DARK",progressStyle:"HORIZONTAL",cancelable:!1,title:"版本升级",message:"下载中..."})}function s(n){cordova.plugin.pDialog.setProgress(n)}function f(){cordova.plugin.pDialog.dismiss()}function d(o){var e=n.defer();l();var t=o.path+o.filename,r=0;return c(o.url,t).then(function(n){console.log("下载成功",n),o.downloadSuccessCb(n),f(),u(t).then(function(){console.log("打开成功"),e.resolve()},function(){console.log("打开失败"),e.reject()})},function(n){console.log("下载失败",n),f(),e.reject(n)},function(n){r=Math.floor(n.loaded/n.total*100),s(r),r>99&&f()}),e.promise}function g(o){var e=n.defer();return cordova.InAppBrowser.open(o.url,"_system"),e.resolve(),e.promise}function v(n){var o=new Date;return o.toDateString()===n.toDateString()}function p(){var n=r.getJsonObj("upgradeSuggestionInfo");return!(!n||!v(new Date(n.last_suggest_date)))}function w(){var e=n.defer();return a.showAlert("在使用前您必须更新!","更新提醒","去更新").then(function(){m().then(function(){e.resolve(),o(w,500)},function(){e.reject()})}),e.promise}function h(e){return e=e||n.defer(),p()?e.reject():a.showConfirm("新版本上线啦","更新提醒",["去更新","暂不更新"]).then(function(n){if(1==n)m().then(function(){o(angular.bind(null,h,e),500)},function(){e.reject()});else if(2==n){var t={last_suggest_date:i("date")(new Date,"yyyy-MM-dd")};console.log(t),r.setJsonObj("upgradeSuggestionInfo",t),e.reject()}else e.reject()}),e.promise}var m,S,D=ionic.Platform.platform();this.init=function(n){var o=n.iOSDownloadUrl,e=void 0===o?"":o,t=n.androidDownloadUrl,r=void 0===t?"":t,i=n.path,a=void 0===i?cordova.file.externalApplicationStorageDirectory:i,c=n.filename,u=void 0===c?"new_version.apk":c,l=n.downloadSuccessCb,s=void 0===l?function(){}:l,f={ios:{url:e},android:{url:r,path:a,filename:u,downloadSuccessCb:s}}[D];if(!f.url)throw new Error("undefined url");m={ios:function(){return g(f)},android:function(){return d(f)}}[D],S={force:function(){return w()},suggest:function(){return h()}}},this.start=function(n){if(!m||!S)throw new Error("AppUpdate not init");return S[n].call()}}]);