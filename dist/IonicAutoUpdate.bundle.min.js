"use strict";angular.module("ionicAutoUpdate",[]).service("NativeAlert",["$q",function(o){this.showAlert=function(n,e,t){var r=o.defer();return navigator.notification&&navigator.notification.alert(n,function(){r.resolve()},e,t),r.promise},this.showConfirm=function(n,e,t){var r=o.defer();return navigator.notification&&navigator.notification.confirm(n,function(o){r.resolve(o)},e,t),r.promise}}]).service("BSYLocalStorage",function(){this.setStr=function(o,n){window.localStorage[o]=n},this.getStr=function(o){return window.localStorage[o]||""},this.setJsonObj=function(o,n){window.localStorage[o]=JSON.stringify(n)},this.getJsonObj=function(o){return JSON.parse(window.localStorage[o]||"{}")},this.remove=function(o){window.localStorage.removeItem(o)}}).service("IonicAutoUpdate",["$q","$timeout","$cordovaFileTransfer","$cordovaFileOpener2","BSYLocalStorage","$filter","NativeAlert",function(o,n,e,t,r,i,a){function c(o,n){return e.download(o,n,{},!0)}function u(o){return t.open(o,"application/vnd.android.package-archive")}function l(){cordova.plugin.pDialog.init({theme:"HOLO_DARK",progressStyle:"HORIZONTAL",cancelable:!1,title:"版本升级",message:"下载中..."})}function s(o){cordova.plugin.pDialog.setProgress(o)}function f(){cordova.plugin.pDialog.dismiss()}function d(n){var e=o.defer();l();var t=n.path+n.filename,r=0;return c(n.url,t).then(function(o){console.log("下载成功",o),n.downloadSuccessCb(o),f(),u(t).then(function(){console.log("打开成功"),e.resolve()},function(){console.log("打开失败"),e.reject()})},function(o){console.log("下载失败",o),f(),e.reject(o)},function(o){r=Math.floor(o.loaded/o.total*100),s(r),r>99&&f()}),e.promise}function g(n){var e=o.defer();return cordova.InAppBrowser.open(n.url,"_system"),e.resolve(),e.promise}function v(o){var n=new Date;return n.toDateString()===o.toDateString()}function p(){var o=r.getJsonObj("upgradeSuggestionInfo");return!(!o||!v(new Date(o.last_suggest_date)))}function w(){var e=o.defer();return a.showAlert("在使用前您必须更新!","更新提醒","去更新").then(function(){m().then(function(){e.resolve(),n(w,500)},function(){e.reject()})}),e.promise}function h(){var e=o.defer();return p()?e.reject():a.showConfirm("新版本上线啦","更新提醒",["去更新","暂不更新"]).then(function(o){if(1==o)m().then(function(){n(h,500)},function(){e.reject()});else if(2==o){var t={last_suggest_date:i("date")(new Date,"yyyy-MM-dd")};console.log(t),r.setJsonObj("upgradeSuggestionInfo",t),e.reject()}else e.reject()}),e.promise}var m,S,D=ionic.Platform.platform();this.init=function(o){var n=o.iOSDownloadUrl,e=void 0===n?"":n,t=o.androidDownloadUrl,r=void 0===t?"":t,i=o.path,a=void 0===i?cordova.file.externalApplicationStorageDirectory:i,c=o.filename,u=void 0===c?"new_version.apk":c,l=o.downloadSuccessCb,s=void 0===l?function(){}:l,f={ios:{url:e},android:{url:r,path:a,filename:u,downloadSuccessCb:s}}[D];if(!f.url)throw new Error("undefined url");m={ios:function(){return g(f)},android:function(){return d(f)}}[D],S={force:function(){return w()},suggest:function(){return h()}}},this.start=function(o){if(!m||!S)throw new Error("AppUpdate not init");return S[o].call()}}]);