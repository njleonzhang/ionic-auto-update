"use strict";angular.module("ionicAutoUpdate",[]).service("IonicAutoUpdate",["$q","$timeout","$cordovaFileTransfer","$cordovaFileOpener2","$filter",function(n,o,e,t,i){function r(o,e,t){var i=n.defer();return window.navigator.notification&&window.navigator.notification.alert(o,function(){i.resolve()},e,t),i.promise}function a(o,e,t){var i=n.defer();return window.navigator.notification&&window.navigator.notification.confirm(o,function(n){i.resolve(n)},e,t),i.promise}function c(n,o){window.localStorage[n]=JSON.stringify(o)}function u(n){return JSON.parse(window.localStorage[n]||"{}")}function l(n,o){return e.download(n,o,{},!0)}function d(n){return t.open(n,"application/vnd.android.package-archive")}function f(){window.cordova.plugin.pDialog.init({theme:"HOLO_DARK",progressStyle:"HORIZONTAL",cancelable:!1,title:"版本升级",message:"下载中..."})}function s(n){window.cordova.plugin.pDialog.setProgress(n)}function g(){window.cordova.plugin.pDialog.dismiss()}function w(o){var e=n.defer();f();var t=o.path+o.filename,i=0;return l(o.url,t).then(function(n){console.log("下载成功",n),o.downloadSuccessCb(n),g(),d(t).then(function(){console.log("打开成功"),e.resolve()},function(){console.log("打开失败"),e.reject()})},function(n){console.log("下载失败",n),g(),e.reject(n)},function(n){i=Math.floor(n.loaded/n.total*100),s(i),i>99&&g()}),e.promise}function v(o){var e=n.defer();return window.cordova.InAppBrowser.open(o.url,"_system"),e.resolve(),e.promise}function p(n){var o=new Date;return o.toDateString()===n.toDateString()}function m(){var n=u("upgradeSuggestionInfo");return!(!n||!p(new Date(n.last_suggest_date)))}function h(){var e=n.defer();return r("在使用前您必须更新!","更新提醒","去更新").then(function(){y().then(function(){e.resolve(),o(h,500)},function(){e.reject()})}),e.promise}function S(e){return e=e||n.defer(),m()?e.reject():a("新版本上线啦","更新提醒",["去更新","暂不更新"]).then(function(n){if(1===n)y().then(function(){o(angular.bind(null,S,e),500)},function(){e.reject()});else if(2===n){var t={last_suggest_date:i("date")(new Date,"yyyy-MM-dd")};console.log(t),c("upgradeSuggestionInfo",t),e.reject()}else e.reject()}),e.promise}var D=window.ionic.Platform.platform(),y=void 0,O=void 0;this.init=function(n){var o=n.iOSDownloadUrl,e=void 0===o?"":o,t=n.androidDownloadUrl,i=void 0===t?"":t,r=n.path,a=void 0===r?window.cordova.file.externalApplicationStorageDirectory:r,c=n.filename,u=void 0===c?"new_version.apk":c,l=n.downloadSuccessCb,d=void 0===l?function(){}:l,f={ios:{url:e},android:{url:i,path:a,filename:u,downloadSuccessCb:d}}[D];if(!f.url)throw new Error("undefined url");y={ios:function(){return v(f)},android:function(){return w(f)}}[D],O={force:function(){return h()},suggest:function(){return S()}}},this.start=function(n){if(!y||!O)throw new Error("AppUpdate not init");return O[n].call()}}]);